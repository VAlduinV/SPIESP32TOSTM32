# üì° –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è –¥–æ ESP32 SPI Master (ESP-IDF. SPIESP32TOSTM32)

–¶–µ–π –∫–æ–¥ —Ä–µ–∞–ª—ñ–∑—É—î **SPI-–º–∞—Å—Ç–µ—Ä** –Ω–∞ ESP32, —è–∫–∏–π –ø–µ—Ä–µ–¥–∞—î –±–∞–π—Ç `0x42` —á–µ—Ä–µ–∑ SPI, –æ—Ç—Ä–∏–º—É—î –≤—ñ–¥–ø–æ–≤—ñ–¥—å –≤—ñ–¥ SPI-slave (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, STM32), —ñ –º–æ—Ä–≥–∞—î —Å–≤—ñ—Ç–ª–æ–¥—ñ–æ–¥–æ–º —É —Ä–∞–∑—ñ —É—Å–ø—ñ—à–Ω–æ–≥–æ –æ–±–º—ñ–Ω—É.

![SPI schema](IMAGE/SPI_ESP32_STM32.jpg)


---

## üì¶ –í–∫–ª—é—á–µ–Ω—ñ –∑–∞–≥–æ–ª–æ–≤–∫–∏

```c
#include "driver/spi_master.h"
#include "driver/gpio.h"
#include "esp_log.h"
#include "rom/gpio.h"
#include <string.h>
```

–¶—ñ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –ø–æ—Ç—Ä—ñ–±–Ω—ñ –¥–ª—è:

- –∫–µ—Ä—É–≤–∞–Ω–Ω—è SPI (spi_master.h)

- –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è GPIO (gpio.h)

- –ª–æ–≥—É–≤–∞–Ω–Ω—è (esp_log.h)

- –±–∞–∑–æ–≤–∏—Ö —Ñ—É–Ω–∫—Ü—ñ–π (string.h, rom/gpio.h)

## üîå –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è –ø—ñ–Ω—ñ–≤

```c
#define PIN_NUM_MISO 19
#define PIN_NUM_MOSI 23
#define PIN_NUM_CLK  18
#define PIN_NUM_CS   5
#define PIN_NUM_LED  2
```

SPI –ø—ñ–Ω-–∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è:

- MISO ‚Üê –≤—ñ–¥ Slave

- MOSI ‚Üí –¥–æ Slave

- CLK ‚Üí —Ç–∞–∫—Ç–æ–≤–∞

- CS ‚Üí chip select

- **PIN_NUM_LED** ‚Äî –≤–±—É–¥–æ–≤–∞–Ω–∏–π —Å–≤—ñ—Ç–ª–æ–¥—ñ–æ–¥ ESP32 (GPIO2)

## üîß –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è

GPIO –¥–ª—è LED

```c
gpio_pad_select_gpio(PIN_NUM_LED);
gpio_set_direction(PIN_NUM_LED, GPIO_MODE_OUTPUT);
gpio_set_level(PIN_NUM_LED, 0);
```

- LED –≤–∏–º–∏–∫–∞—î—Ç—å—Å—è –Ω–∞ —Å—Ç–∞—Ä—Ç—ñ.

## üõ† –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è SPI

**Bus config**

```c
spi_bus_config_t buscfg = {
    .miso_io_num = PIN_NUM_MISO,
    .mosi_io_num = PIN_NUM_MOSI,
    .sclk_io_num = PIN_NUM_CLK,
    .quadwp_io_num = -1,
    .quadhd_io_num = -1,
    .max_transfer_sz = 1,
};
```

- –ó–≤–∏—á–∞–π–Ω–∞ SPI-—à–∏–Ω–∞ –±–µ–∑ Quad —Ä–µ–∂–∏–º—É.

- –ü–µ—Ä–µ–¥–∞—á–∞ –æ–¥–Ω–æ–≥–æ –±–∞–π—Ç–∞ –∑–∞ —Ä–∞–∑.

**Device config**

```c
spi_device_interface_config_t devcfg = {
    .clock_speed_hz = 1 * 1000 * 1000,
    .mode = 0,
    .spics_io_num = PIN_NUM_CS,
    .queue_size = 1,
};
```

- –®–≤–∏–¥–∫—ñ—Å—Ç—å SPI: 1 –ú–ì—Ü

- –†–µ–∂–∏–º SPI: Mode 0 (CPOL=0, CPHA=0)

- CS –∫–µ—Ä—É—î—Ç—å—Å—è –∞–ø–∞—Ä–∞—Ç–Ω–æ

## üîÑ –û—Å–Ω–æ–≤–Ω–∏–π —Ü–∏–∫–ª

**–ó–º—ñ–Ω–Ω—ñ:**

```c
uint8_t tx_data = 0x42; // –ë–∞–π—Ç –Ω–∞ –ø–µ—Ä–µ–¥–∞—á—É
uint8_t rx_data;        // –ë–∞–π—Ç –¥–ª—è –ø—Ä–∏–π–æ–º—É
```

**–¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è:**

```c
spi_transaction_t t;
memset(&t, 0, sizeof(t));
t.length = 8;
t.tx_buffer = &tx_data;
t.rx_buffer = &rx_data;
```

**–¶–∏–∫–ª –ø–µ—Ä–µ–¥–∞—á—ñ:**

```c
while (1) {
    spi_device_transmit(spi, &t);

    // –Ø–∫—â–æ —É—Å–ø—ñ—à–Ω–æ ‚Äî –ª–æ–≥ —ñ –º–∏–≥–æ—Ç—ñ–Ω–Ω—è LED
    gpio_set_level(PIN_NUM_LED, 1);
    vTaskDelay(pdMS_TO_TICKS(100));
    gpio_set_level(PIN_NUM_LED, 0);

    vTaskDelay(pdMS_TO_TICKS(900)); // –∑–∞–≥–∞–ª—å–Ω–∞ –ø–∞—É–∑–∞ ‚Äî 1 —Å–µ–∫—É–Ω–¥–∞
}
```

- –©–æ—Å–µ–∫—É–Ω–¥–∏ –ø–µ—Ä–µ–¥–∞—î—Ç—å—Å—è 1 –±–∞–π—Ç (0x42).

- –Ø–∫—â–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –æ—Ç—Ä–∏–º–∞–Ω–æ ‚Äî —Å–≤—ñ—Ç–ª–æ–¥—ñ–æ–¥ –±–ª–∏–º–∞—î –Ω–∞ 100 –º—Å.

- –í –ª–æ–≥ –≤–∏–≤–æ–¥–∏—Ç—å—Å—è:

```
Sent: 0x42, Received: 0xAB
```

## üß™ –í–∑–∞—î–º–æ–¥—ñ—è –∑ STM32 (Slave)

–¶–µ–π –∫–æ–¥ —Å—É–º—ñ—Å–Ω–∏–π –∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–º STM32 SPI Slave:

- STM32 –∑–∞–≤–∂–¥–∏ –ø–æ–≤–µ—Ä—Ç–∞—î 0xAB.

- ESP32 –ø–µ—Ä–µ–¥–∞—î 0x42, –æ—á—ñ–∫—É—î –≤—ñ–¥–ø–æ–≤—ñ–¥—å.

–£ —Ä–∞–∑—ñ —É—Å–ø—ñ—à–Ω–æ–≥–æ –æ–±–º—ñ–Ω—É:

- –£ –ª–æ–≥ ‚Äî Sent: 0x42, Received: 0xAB

- LED –±–ª–∏–º–∞—î.

## üìà –ü–æ—Ç–µ–Ω—Ü—ñ–π–Ω—ñ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è

- –û–±—Ä–æ–±–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–∏—Ö –¥–∞–Ω–∏—Ö (rx_data) –¥–ª—è –ø—Ä–∏–π–æ–º—É –∫–æ–º–∞–Ω–¥ –∞–±–æ —Å—Ç–∞—Ç—É—Å—ñ–≤.

- –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —á–µ—Ä–≥–∏ –ø–µ—Ä–µ–¥–∞—á (queue_size > 1) –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π.

- –í–∏–≤–µ–¥–µ–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ –Ω–∞ –¥–∏—Å–ø–ª–µ–π –∞–±–æ –≤—ñ–¥–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ Wi-Fi.

## ‚úÖ –ü—ñ–¥—Å—É–º–æ–∫

ESP32:

- –í–∏–∫–æ–Ω—É—î SPI Master –ø–µ—Ä–µ–¥–∞—á—É –≤ —Ä–µ–∂–∏–º—ñ Mode 0.

- –ü–µ—Ä–µ–¥–∞—î 0x42 ‚Üí –æ—á—ñ–∫—É—î –≤—ñ–¥–ø–æ–≤—ñ–¥—å 0xAB –≤—ñ–¥ STM32.

- –õ–æ–≥ —ñ –º–∏–≥–æ—Ç—ñ–Ω–Ω—è LED –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂—É—é—Ç—å –∞–∫—Ç–∏–≤–Ω—É –∫–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—é.

